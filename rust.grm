(* rust.yacc *)
open DataTypes

fun yaccLog(msg) = ErrorMsg.yaccLog (msg)
fun error(pos, msg) = ErrorMsg.error pos

%%
%term EOF
    | AS | BREAK | CONST | CONTINUE | CRATE | ELSE | ENUM | EXTERN     
        | FALSE | FN | FOR | IF | IMPL | IN | LET | LOOP | MATCH | MOD | MOVE
        | MUT | PUB | REF | RETURN | SELFVALUE | SELFTYPE | STATIC | STRUCT 
        | SUPER | TRAIT | TRUE | TYPE | UNSAFE | USE | WHERE | WHILE | DYN
    | ABSTRACT | BECOME | BOX | DO | FINAL | MACRO | OVERRIDE
        | PRIV | TYPEOF | UNSIZED | VIRTUAL | YIELD
        | ASYNC | AWAIT | TRY
    | UNION | STATICLIFETIME
    | IDENT of string
    | CHAR_LIT of string 
        | STR_LIT of string | RAW_STR_LIT of string
        | BYTE_LIT of string | BYTE_STR_LIT of string | RAW_BYTE_STR_LIT of string
        | INTEGER_LIT of string | TUPLE_INDEX of string 
        | FLOAT_LIT of string
        | INTEGER_SUFFIX of string | FLOAT_SUFFIX of string
    | LIFETIME_OR_LABEL of string | LIFETIME_TOKEN of string
    | PLUS | MINUS | STAR | SLASH | PERCENT | CARET
        | NOT | AND | OR | ANDAND | OROR | SHL | SHR
        | PLUSEQ | MINUSEQ | STAREQ | SLASHEQ | PERCENTEQ | CARETEQ | ANDEQ | OREQ
        | SHLEQ | SHREQ | EQ | EQEQ
        | NE | GT | LT | GE | LE
        | AT | UNDERSCORE | DOT | DOTDOT | DOTDOTDOT | DOTDOTEQ
        | COMMA | SEMI | COLON | PATHSEP | RARROW | FATARROW | POUND | DOLLAR | QUESTION
        | LBRACE | RBRACE | LBRACKET | RBRACKET | LPARENT | RPARENT
        | INNER_DOC_COMMENT of string | OUTER_DOC_COMMENT of string
        | SHEBANG | SHEBANG_LINE of string
    | LOWER_THAN_LPARENT | LOWER_THAN_PATHSEP | LOWER_THAN_EXPR | LOWER_THAN_COLON | LOWER_THAN_PLUS
    | LAMBDA | SHIFTPLUS | FORTYPE | RANGE
%nonterm crate of Crate | inner_attrs of InnerAttribute list | items of Item list
        | outer_attrs of OuterAttribute list
        | inner_attr of InnerAttribute | outer_attr of OuterAttribute | meta_item of MetaItem 
        | meta_seq of MetaItemInner list | meta_seq_expansion of MetaItemInner list | meta_item_inner of MetaItemInner

        | path | simple_path of PathSeg list | simple_path_segment of PathSeg | path_segment of PathSeg
        | path_exp | path_in_exp | path_in_exp_with_generic | path_exp_segment
        | qualified_path_in_exp | qualified_path_in_exp_expansion | qualified_path_type | qualified_path_in_type | qualified_path_in_type_expansion
        | type_path of TypePath | type_path_segment | type_path_with_generic_fn | type_path_fn | type_path_fn_inputs | type_path_fn_inputs_expansion
        
        | item of Item | vis_item of VisItem | macro_item
        | visibility of Visibility | item_type of ItemType
        | use_tree of UseTree | use_tree_multi of UseTree list | use_tree_multi_expansion of UseTree list
        | patterns of Pattern | lit_pat | id_pat | binding_mode | wildcard_pat | range_pat | range_pat_bound | reference_pat 
        | struct_pat | struct_pat_elements | struct_pat_fields | struct_pat_etcetera | struct_pat_field
        | tuple_struct_pat | tuple_struct_items
        | tuple_or_grouped_pat | tuple_pat_items
        | grouped_pat | slice_pat | path_pat
        | types of Type | types_expansion 
        | maybe_named_bare_func_parameters | maybe_named_bare_func_parameters_variadic | maybe_named_param
        | generics of Generics | maybe_generics of Generics option | generic_params of GenericParams | maybe_visibility of Visibility
        | where_clause of WhereClause | maybe_where_clause of WhereClause option | where_clause_expansion of WhereClauseItem list
        | where_clause_item of WhereClauseItem | lifetime_where_clause_item of WhereClauseItem | type_bound_where_clause_item of WhereClauseItem
        | lifetime_params of LifetimeParam list | lifetime_param of LifetimeParam | lifetime_params_expansion of LifetimeParam list
        | type_params of TypeParam list | type_params_expansion of TypeParam list | type_param of TypeParam | maybe_type_param
        | maybe_lifetime_param | maybe_colon_lifetime_bounds of LifetimeBounds option | lifetime_param_tail | maybe_colon_type_bounds of TypeParamBounds option
        | maybe_comma | maybe_plus | maybe_ques | maybe_not | maybe_outer_attr of OuterAttribute option
        | function of ItemType | func_qualifier of FunctionQualifier list | maybe_unsafe of Unsafe option | abi of Abi | maybe_abi of Abi option
        | func_parameters of FunctionParam list | maybe_func_parameters of FunctionParam list| func_param of FunctionParam | func_parameters_expansion of FunctionParam list
        | func_return_type of Type | maybe_func_return_type of Type option
        | struct_struct of StructType| struct_fields of StructField list | struct_field of StructField 
        | maybe_struct_fields of StructField list | struct_fields_expansion of StructField list
        | tuple_struct of StructType | tuple_fields of TupleField list | tuple_field of TupleField 
        | maybe_tuple_fields of TupleField list | tuple_fields_expansion of TupleField list
        | enum_items of EnumItem list | maybe_enum_items of EnumItem list | enum_items_expansion of EnumItem list 
        | enum_item of EnumItem | enum_item_tuple of EnumItemType | enum_item_struct of EnumItemType | enum_item_discriminant of EnumItemType
        | type_alias of ItemType | constant_item of ItemType
        | maybe_type_param_bounds of TypeParamBounds option | type_param_bounds of TypeParamBounds
        | type_param_bounds_expansion of TypeParamBound list | type_param_bound of TypeParamBound
        | lifetime of Lifetime | lifetime_bounds of LifetimeBounds | lifetime_bounds_expansion of Lifetime list | maybe_lifetime
        | trait_bound of TraitBound | for_lifetimes of ForLifetimes | maybe_for_lifetimes of ForLifetimes option
        | trait_items of TraitItem list | trait_item of TraitItem 
        | trait_func of TraitItemType | trait_method of TraitItemType | trait_const of TraitItemType | trait_type of TraitItemType
        | trait_func_decl of TraitFuncDecl | trait_method_decl of TraitMethodDecl
        | macro_invocation | macro_invocation_semi of MacroInvocationSemi | macro_rules_definition | macro_rules_def
        | macro_rules | macro_rules_expansion | macro_rule | macro_matcher | macro_transcriber | macro_match | macro_matches
        | macro_frag_spec | macro_rep_sep | macro_kleene_op
        | trait_func_parameters of TraitFunctionParam list | trait_func_param of TraitFunctionParam 
        | maybe_trait_func_parameters of TraitFunctionParam list | trait_func_parameters_expansion of TraitFunctionParam list
        | self_param of SelfParam| maybe_and_or_lifetime | maybe_mut of Mutability
        | inherent_impl of ItemType | trait_impl of ItemType
        | inherent_impl_items of InherentImplItem list | inherent_impl_items_expansion of InherentImplItem list | inherent_impl_item of InherentImplItem
        | trait_impl_items  of TraitImplItem list | trait_impl_items_expansion of TraitImplItem list | trait_impl_item of TraitImplItem
        | method of Method
        | extern_block of ItemType | external_items of ExternalItem list| external_item of ExternalItem 
        | external_static_item of ExternalItemType | external_func_item of ExternalItemType
        | maybe_named_func_parameters of ExternFunctionParameter
        | named_func_parameters of ExternFunctionParameter | named_func_parameters_expansion of NamedFunctionParam list
        | named_func_parameters_with_variadics of ExternFunctionParameter| named_func_param of NamedFunctionParam

        | maybe_statements | statements |statements_expansion | statement | let_statement | exp_statement 
        | expressions | expression of Expression | exp_nostruct | exp_nostruct_nolazybop
        | exp_without_block | lit_exp of LiteralExpression | str_lit of TokenType | bool_lit of TokenType
        | generic_args | generic_args_lifetimes | generic_args_types | generic_args_bindings | generic_args_binding
        | op_exp | grouped_exp 
        | array_exp | array_elements | array_elements_expansion | index_exp 
        | tuple_exp | tuple_elements | tuple_elements_expansion | tuple_index_exp 
        | struct_exp | struct_exp_struct | struct_exp_tuple | struct_exp_unit
        | struct_exp_fields | struct_exp_fields_expansion | struct_base | struct_exp_field
        | enum_var_exp | enum_exp_struct | enum_exp_tuple | enum_exp_field_less 
        | enum_exp_fields | enum_exp_fields_expansion | enum_exp_field
        | call_exp | call_params | maybe_call_params | call_params_expansion 
        | method_call_exp | field_exp 
        | closure_exp | closure_parameters | closure_param | closure_parameters_expansion
        | continue_exp | break_exp | range_exp 
        | return_exp
        | exp_with_block | block_exp of BlockExpression | unsafe_block_exp 
        | loop_exp | maybe_loop_label | if_exp | if_let_exp 
        | match_exp | match_arms | match_arms_expansion | match_arm | match_arm_patterns | match_arm_guard
        | type_no_bounds

        | token_trees | token_tree | delim_token_tree
        | token_no_delim | token_no_delim_kleene | token_no_delim_dollar | token_no_delim_kleene_dollar
%pos int
%eop EOF
%noshift EOF
%name Rust
%keyword AS BREAK CONST CONTINUE CRATE ELSE ENUM EXTERN
        FALSE FN FOR IF IMPL IN LET LOOP MATCH MOD MOVE
        MUT PUB REF RETURN SELFVALUE SELFTYPE STATIC STRUCT
        SUPER TRAIT TRUE TYPE UNSAFE USE WHERE WHILE
        ABSTRACT BECOME BOX DO FINAL MACRO OVERRIDE
        PRIV TYPEOF UNSIZED VIRTUAL YIELD

%nonassoc LAMBDA
%nonassoc SELFVALUE
%nonassoc MUT
%nonassoc IDENT
%nonassoc SHIFTPLUS
%nonassoc LOWER_THAN_PATHSEP
%nonassoc PATHSEP
%nonassoc LOWER_THAN_COLON
%nonassoc RARROW COLON

(* For solving shift/reduce conflicts in type and lifetime *)
(*
    // In where clauses, "for" should have greater precedence when used as
    // a higher ranked constraint than when used as the beginning of a
    // for_in_type (which is a ty)
*)
%nonassoc FORTYPE
%nonassoc FOR

%nonassoc QUESTION
%nonassoc BOX
%nonassoc DOTDOT
%nonassoc RETURN YIELD

%nonassoc LOWER_THAN_EXPR

%right EQ SHLEQ SHREQ PLUSEQ MINUSEQ ANDEQ OREQ STAREQ SLASHEQ CARETEQ PERCENTEQ DOTDOTEQ
%left OROR
%left ANDAND
%left EQEQ NE
%left LT GT LE GE
%left OR
%left CARET
%left AND
%left SHL SHR
%nonassoc LOWER_THAN_PLUS
%left PLUS MINUS
%nonassoc AS
%left STAR SLASH PERCENT

%nonassoc NOT
%nonassoc LOWER_THAN_LPARENT
%nonassoc LBRACE LBRACKET LPARENT DOT

%nonassoc RANGE

%verbose

%%
crate: SHEBANG_LINE inner_attrs items                          (Crate (Shebang (SOME SHEBANG_LINE), rev(inner_attrs), rev(items)))
        | inner_attrs items                                    (Crate (Shebang (NONE), rev(inner_attrs), rev(items)))

items: items item                                              (item::items)
        |                                                      ([])

item: outer_attrs vis_item                                     (VisItemType (rev(outer_attrs), vis_item))
    | outer_attrs macro_item                                               (MacroItemType (MacroItem))

(* -----Macro------ *)
(* macro_invocation: simple_path NOT delim_token_tree              () *)
macro_invocation: path_in_exp NOT delim_token_tree              ()

macro_item: macro_invocation_semi                               (yaccLog("macro_invocation_semi"))
            | macro_rules_definition                            (yaccLog("macro_rules_definition"))

(* macro_invocation_semi: simple_path NOT 
                        LPARENT token_trees RPARENT SEMI        (MacroInvocationSemi)
                    | simple_path NOT 
                        LBRACKET token_trees RBRACKET SEMI      (MacroInvocationSemi)
                    | simple_path NOT 
                        LBRACE token_trees RBRACE               (MacroInvocationSemi) *)

macro_invocation_semi: path_in_exp NOT 
                        LPARENT token_trees RPARENT SEMI        (MacroInvocationSemi)
                    | path_in_exp NOT 
                        LBRACKET token_trees RBRACKET SEMI      (MacroInvocationSemi)
                    | path_in_exp NOT 
                        LBRACE token_trees RBRACE               (MacroInvocationSemi)

token_trees: token_trees token_tree                             ()
            |                                                   ()
token_tree: token_no_delim                                      ()
            | delim_token_tree                                  ()
delim_token_tree: LPARENT token_trees RPARENT                   ()
                | LBRACKET token_trees RBRACKET                 ()
                | LBRACE token_trees RBRACE                     ()

(* the path_in_exp must be [macro_rules] *)
(* macro_rules_definition: simple_path NOT IDENT macro_rules_def   () *)
macro_rules_definition: path_in_exp NOT IDENT macro_rules_def   ()
macro_rules_def: LPARENT macro_rules RPARENT SEMI               ()
            | LBRACKET macro_rules RBRACKET SEMI                ()
            | LBRACE macro_rules RBRACE                         ()
macro_rules: macro_rule macro_rules_expansion SEMI              ()
            | macro_rule macro_rules_expansion                  ()
macro_rules_expansion: macro_rules_expansion SEMI macro_rule    ()
                    |                                           ()
macro_rule: macro_matcher FATARROW macro_transcriber            (yaccLog("macro_rule"))
macro_matcher: LPARENT macro_matches RPARENT                    ()
            | LBRACKET macro_matches RBRACKET                   ()
            | LBRACE macro_matches RBRACE                       ()
macro_matches: macro_matches macro_match                        ()
            |                                                   ()
macro_match: token_no_delim_dollar                              ()
            | macro_matcher                                     ()
            | DOLLAR IDENT COLON macro_frag_spec                ()
            | DOLLAR SELFVALUE COLON macro_frag_spec                ()
            | DOLLAR LPARENT macro_match macro_matches RPARENT 
                macro_kleene_op                                 ()
            | DOLLAR LPARENT macro_match macro_matches RPARENT 
                macro_rep_sep macro_kleene_op                   ()     
macro_frag_spec: IDENT                                          ()
macro_rep_sep: token_no_delim_kleene                            ()
macro_kleene_op: STAR                                           ()
                | PLUS                                          ()
                | QUESTION                                      ()
macro_transcriber: delim_token_tree                             ()

(* ------VisItem------ *)
vis_item: maybe_visibility item_type                            (VisItem(DefaultVis, item_type))

maybe_visibility: visibility                                    (visibility)
                    |                                           (DefaultVis)

visibility: PUB %prec LOWER_THAN_LPARENT                        (PubVis)
        | PUB LPARENT CRATE RPARENT                             (CrateVis)
        | PUB LPARENT SELFVALUE RPARENT                         (SelfVis)
        | PUB LPARENT SUPER RPARENT                             (SuperVis)
        | PUB LPARENT IN simple_path RPARENT                    (InVis (SimplePath(rev(simple_path))))

use_tree: simple_path                                           (yaccLog("use_tree:branch 1"); UseAlias (SimplePath(rev(simple_path)), NONE))
        | simple_path AS IDENT                                  (yaccLog("use_tree:branch 2"); UseAlias (SimplePath(rev(simple_path)), SOME(Identifer(IDENT))))
        | STAR                                                  (yaccLog("use_tree:branch 3"); UseAll (NONE))
        | PATHSEP STAR                                          (yaccLog("use_tree:branch 4"); UseAll (SOME(SimplePath([DefaultPat]))))
        | simple_path PATHSEP STAR                              (yaccLog("use_tree:branch 5"); UseAll (SOME(SimplePath(rev(simple_path)))))
        | use_tree_multi                                        (yaccLog("use_tree:branch 6"); UseList (NONE, use_tree_multi))
        | PATHSEP use_tree_multi                                (yaccLog("use_tree:branch 7"); UseList (SOME(SimplePath([DefaultPat])), use_tree_multi))
        | simple_path PATHSEP use_tree_multi                    (yaccLog("use_tree:branch 8"); UseList (SOME(SimplePath(rev(simple_path))), use_tree_multi))
use_tree_multi: LBRACE use_tree 
                use_tree_multi_expansion maybe_comma RBRACE     (use_tree::rev(use_tree_multi_expansion))
                | LBRACE RBRACE                                 ([])
use_tree_multi_expansion: use_tree_multi_expansion
                            COMMA use_tree                      (use_tree::use_tree_multi_expansion)
                        |                                       (nil)                       

inner_attrs: inner_attrs inner_attr                             (yaccLog("inner_attrs"); inner_attr::inner_attrs)
            |                                                   ([])
outer_attrs: outer_attrs outer_attr                             (yaccLog("outer_attrs"); outer_attr::outer_attrs)
            |                                                   ([])

maybe_outer_attr: outer_attr                                    (SOME(outer_attr))
                |                                               (NONE)
inner_attr: SHEBANG LBRACKET meta_item RBRACKET                 (yaccLog("inner_attr"); InnerAttribute(meta_item))
            | INNER_DOC_COMMENT                                 (InnerAttribute(AttrName (SimplePath([]))))
outer_attr: POUND LBRACKET meta_item RBRACKET                   (OuterAttribute meta_item)
            | OUTER_DOC_COMMENT                                 (OuterAttribute(AttrName (SimplePath([]))))

meta_item: simple_path EQ lit_exp                               (AttrKVPair(SimplePath(rev(simple_path)), lit_exp))
        | simple_path LPARENT meta_seq RPARENT                  (AttrSubs(SimplePath(rev(simple_path)), rev(meta_seq)))
        | simple_path LPARENT meta_seq COMMA RPARENT            (AttrSubs(SimplePath(rev(simple_path)), rev(meta_seq)))
        | simple_path LPARENT RPARENT                           (AttrSubs(SimplePath(rev(simple_path)), []))
        | simple_path %prec LOWER_THAN_LPARENT                  (AttrName (SimplePath(rev(simple_path))))

meta_seq: meta_item_inner                                       ([meta_item_inner])
        | meta_seq COMMA meta_item_inner                        (meta_item_inner::meta_seq)

meta_item_inner: meta_item                                      (MetaItem(meta_item))
                | lit_exp                                       (MetaLit(lit_exp))

(* rewrite simple path production*)
simple_path:  simple_path_segment                               ([simple_path_segment])
            | PATHSEP simple_path_segment                       ([DefaultPat, simple_path_segment])
            | simple_path PATHSEP simple_path_segment           (simple_path_segment::simple_path)
(* simple_path: path_in_exp %prec LOWER_THAN_PATHSEP               ([]) *)
(* simple_path_segment: IDENT                                      (IDPat(Identifer(IDENT)))
                    | SUPER                                     (SuperPat)
                    | SELFVALUE                                 (SelfPat)
                    | CRATE                                     (CratePat)
                    | DOLLAR CRATE                              (DCratePat) *)
simple_path_segment: path_segment  %prec LOWER_THAN_PATHSEP     (path_segment)
path_segment: IDENT                                             (IDPat(Identifer(IDENT)))
            | SUPER                                             (SuperPat)
            | SELFVALUE                                         (SelfPat)
            | CRATE                                             (CratePat)
            | DOLLAR CRATE                                      (DCratePat)

path_in_exp: path_in_exp_with_generic                                   ()
            | PATHSEP path_in_exp_with_generic                          ()

path_in_exp_with_generic: path_segment                          ()
                        | SELFTYPE                              ()
                        | path_in_exp_with_generic PATHSEP path_segment ()
                        | path_in_exp_with_generic PATHSEP SELFTYPE ()
                        | path_in_exp_with_generic PATHSEP generic_args ()

path_exp_segment: path_segment          ()
                | SELFTYPE              ()
                | generic_args          ()

generic_args: LT GT                                             ()
            | LT generic_args_lifetimes maybe_comma GT          ()
            | LT generic_args_types maybe_comma GT              ()
            | LT generic_args_bindings maybe_comma GT           ()
            | LT generic_args_types 
                COMMA generic_args_bindings maybe_comma GT      ()
            | LT generic_args_lifetimes 
                COMMA generic_args_types GT                     ()
            | LT generic_args_lifetimes 
                COMMA generic_args_bindings GT                  ()
            | LT generic_args_lifetimes 
                COMMA generic_args_types 
                COMMA generic_args_bindings GT                  ()
generic_args_lifetimes: generic_args_lifetimes COMMA lifetime   ()
                        | lifetime                              ()
generic_args_types: generic_args_types COMMA types              ()
                    | types                                     ()
generic_args_bindings: generic_args_bindings 
                    COMMA generic_args_binding                  ()
                    | generic_args_binding                      ()
generic_args_binding: IDENT EQ types                            ()

qualified_path_in_exp: qualified_path_type 
                    qualified_path_in_exp_expansion             ()
qualified_path_in_exp_expansion: qualified_path_in_exp_expansion
                                PATHSEP path_exp_segment        ()
                            | PATHSEP path_exp_segment          ()
qualified_path_type: LT types GT                                ()
                    | LT types AS type_path GT                  ()

qualified_path_in_type: qualified_path_type
                    qualified_path_in_type_expansion 
                    %prec LOWER_THAN_PATHSEP                    ()
qualified_path_in_type_expansion: qualified_path_in_type_expansion
                                PATHSEP type_path_segment       ()
                                | PATHSEP type_path_segment     ()

type_path: type_path_with_generic_fn %prec LOWER_THAN_PATHSEP   (TypePath)
        | PATHSEP type_path_with_generic_fn                     (TypePath)

type_path_with_generic_fn: path_segment                         ()
                        | SELFTYPE                              ()
                        | type_path_with_generic_fn 
                            PATHSEP path_segment                ()
                        | type_path_with_generic_fn 
                            PATHSEP SELFTYPE                ()
                        | type_path_with_generic_fn 
                            PATHSEP generic_args                ()
                        | type_path_with_generic_fn 
                            PATHSEP type_path_fn                ()
                        | type_path_with_generic_fn generic_args()
                        | type_path_with_generic_fn type_path_fn()
type_path_segment: path_segment                                 ()
                    | SELFTYPE                                  ()
                    | generic_args                              ()
                    | type_path_fn                              ()                    
type_path_fn: LPARENT RPARENT                                   ()
            | LPARENT RPARENT RARROW types                      ()
            | LPARENT type_path_fn_inputs RPARENT               ()
            | LPARENT type_path_fn_inputs RPARENT RARROW types  ()
type_path_fn_inputs: type_path_fn_inputs_expansion              ()
                    | type_path_fn_inputs_expansion COMMA       ()
type_path_fn_inputs_expansion: type_path_fn_inputs_expansion 
                            COMMA types                         ()
                            | types                             ()
                
maybe_where_clause: where_clause                                (SOME(where_clause))
                    |                                           (NONE)
where_clause: WHERE where_clause_expansion                      (WhereClause (rev (where_clause_expansion)))
            | WHERE where_clause_expansion where_clause_item    (WhereClause (where_clause_item::rev(where_clause_expansion)))
where_clause_expansion: where_clause_expansion 
                    where_clause_item COMMA                     (where_clause_item::where_clause_expansion)
                    |                                           (nil)
where_clause_item: lifetime_where_clause_item                   (lifetime_where_clause_item)
                    | type_bound_where_clause_item              (type_bound_where_clause_item)
lifetime_where_clause_item: lifetime COLON lifetime_bounds      (LifetimeWhereClauseItem(lifetime, lifetime_bounds))
type_bound_where_clause_item: maybe_for_lifetimes types COLON 
                            maybe_type_param_bounds             (TypeBoundWhereClauseItem(maybe_for_lifetimes, types, maybe_type_param_bounds))
maybe_generics: generics                                        (SOME(generics))
                |                                               (NONE)
maybe_for_lifetimes: for_lifetimes                              (SOME(for_lifetimes))
                    | %prec FORTYPE                             (NONE)
for_lifetimes: (* There is no definition in reference, 
            and following production comes from rust repository *)                
            FOR LT lifetime_params GT                           (ForLifetimes(LifetimeParams(rev(lifetime_params))))
            | FOR LT GT                                         (ForLifetimes(LifetimeParams([])))

(* There is a ambiguous token, SHR *)
generics: LT generic_params GT                                  (yaccLog("generics"); Generics(generic_params))
generic_params: lifetime_params                                 (GenericParams (LifetimeParams(rev(lifetime_params)), TypeParams([])))
                | lifetime_params COMMA                         (GenericParams (LifetimeParams(rev(lifetime_params)), TypeParams([])))
                | type_params                                   (GenericParams (LifetimeParams([]), TypeParams(rev(type_params))))
                | type_params COMMA                             (GenericParams (LifetimeParams([]), TypeParams(rev(type_params))))
                | lifetime_params COMMA type_params             (GenericParams (LifetimeParams(rev(lifetime_params)), TypeParams(rev(type_params))))
                | lifetime_params COMMA type_params COMMA       (GenericParams (LifetimeParams(rev(lifetime_params)), TypeParams(rev(type_params))))
                |                                               (GenericParams (LifetimeParams([]), TypeParams([])))
lifetime_params: lifetime_param                                 ([lifetime_param])
                | lifetime_params COMMA lifetime_param          (lifetime_param::lifetime_params)
type_params: type_param                                         ([type_param])
            | type_params COMMA type_param                      (type_param::type_params)
(* generic_params: lifetime_params                                 (yaccLog("generic_params:branch 1"))
                | lifetime_params_expansion type_params         (yaccLog("generic_params:branch 2")) *)
(* lifetime_params: lifetime_params_expansion 
                maybe_lifetime_param                            ()
maybe_lifetime_param: lifetime_param                            ()
                    |                                           ()
lifetime_params_expansion: lifetime_params_expansion
                            lifetime_param COMMA                (yaccLog("lifetime_params_expansion:branch 1"))
                        |                                       (yaccLog("lifetime_params_expansion:branch 2")) *)
(* type_params: type_params_expansion maybe_type_param             ()
type_params_expansion: type_params_expansion 
                    type_param COMMA                            (yaccLog("type_params_expansion:branch 1"))
                    |                                           (yaccLog("type_params_expansion:branch 2"))
maybe_type_param: type_param                                    ()
                |                                               () *)
lifetime_param: maybe_outer_attr
            LIFETIME_OR_LABEL maybe_colon_lifetime_bounds       (yaccLog("lifetime_param"); 
                                                                    LifetimeParam(maybe_outer_attr, 
                                                                            LifetimeOrLabel(LIFETIME_OR_LABEL), 
                                                                            maybe_colon_lifetime_bounds)
                                                                )
maybe_colon_lifetime_bounds: COLON lifetime_bounds              (SOME(lifetime_bounds))
                        |                                       (NONE)
type_param: maybe_outer_attr IDENT maybe_colon_type_bounds      (yaccLog("type_param:branch 1");
                                                                    TypeParam(maybe_outer_attr, Identifer(IDENT), maybe_colon_type_bounds, NONE)
                                                                )
            | maybe_outer_attr IDENT maybe_colon_type_bounds
                EQ types                                        (yaccLog("type_param:branch 2");
                                                                    TypeParam(maybe_outer_attr, Identifer(IDENT), maybe_colon_type_bounds, SOME(types))
                                                                )
maybe_colon_type_bounds: COLON                                  (NONE)
                        | COLON type_param_bounds               (SOME(type_param_bounds))
                        |                                       (NONE)

maybe_comma: COMMA                                              ()
            |                                                   ()
maybe_mut: MUT                                                  (Mut)
            |                                                   (NonMut)
maybe_plus: PLUS                                                ()
            |                                                   ()
maybe_ques: QUESTION                                            ()
            |                                                   ()
maybe_unsafe: UNSAFE                                            (SOME(Unsafe))
            |                                                   (NONE)

item_type: 
        MOD IDENT SEMI                                       (Module (Identifer(IDENT), NONE))
        | MOD IDENT LBRACE inner_attrs items RBRACE             (Module (Identifer(IDENT), SOME(ModuleBody(rev(inner_attrs), rev(items)))))
        | EXTERN CRATE IDENT SEMI                               (yaccLog("extern crate "^IDENT); ExternCrate (Identifer(IDENT), NONE))
        | EXTERN CRATE IDENT AS IDENT SEMI                      (yaccLog("extern crate "^IDENT1^" as"^IDENT2); ExternCrate (Identifer(IDENT1), SOME(Identifer(IDENT2))))
        | USE use_tree SEMI                                     (yaccLog("use_tree"); UseDeclaration(use_tree))
        | function                                              (yaccLog("function"); function)
        | type_alias                                            (yaccLog("type alias"); type_alias)
        | struct_struct                                         (yaccLog("struct struct"); Struct (struct_struct))
        | tuple_struct                                          (yaccLog("tuple struct"); Struct (tuple_struct))
        | ENUM IDENT maybe_generics maybe_where_clause
            LBRACE maybe_enum_items RBRACE                      (yaccLog("enumeration"); 
                                                                Enumeration (Identifer(IDENT), maybe_generics, 
                                                                maybe_where_clause, maybe_enum_items))
        | UNION IDENT maybe_generics maybe_where_clause 
            LBRACE struct_fields RBRACE                         (yaccLog("Union"); Union (Identifer(IDENT), maybe_generics, 
                                                                                        maybe_where_clause, struct_fields))
        | constant_item                                         (yaccLog("ConstantItem"); constant_item)
        | STATIC MUT IDENT COLON types EQ expression SEMI       (yaccLog("StaticItem"); StaticItem (Mut, Identifer(IDENT), types, expression))
        | STATIC IDENT COLON types EQ expression SEMI           (yaccLog("StaticItem"); StaticItem (NonMut, Identifer(IDENT), types, expression))
        | maybe_unsafe TRAIT IDENT maybe_generics
            maybe_colon_type_bounds maybe_where_clause
            LBRACE trait_items RBRACE                           (yaccLog("Trait"); Trait ({
                                                                    unsafe=maybe_unsafe, name=Identifer(IDENT), generic=maybe_generics, 
                                                                    tyb=maybe_colon_type_bounds, wh=maybe_where_clause, 
                                                                    traitItems=rev(trait_items)
                                                                }))
        | inherent_impl                                         (yaccLog("inherent_impl"); inherent_impl)
        | trait_impl                                            (yaccLog("trait_impl"); trait_impl)
        | extern_block                                          (yaccLog("extern_block"); extern_block)

type_alias: TYPE IDENT maybe_generics maybe_where_clause
            EQ types SEMI                                       (TypeAlias (Identifer(IDENT), maybe_generics, maybe_where_clause, types))        
constant_item: CONST IDENT COLON types EQ expression SEMI       (ConstantItem (Identifer(IDENT), types, expression))

function: func_qualifier FN IDENT maybe_generics
            LPARENT maybe_func_parameters RPARENT
            maybe_func_return_type
            maybe_where_clause
            block_exp                                           (Function({ qualifier=func_qualifier, generic=maybe_generics,
                                                                            name=Identifer(IDENT), params=maybe_func_parameters,
                                                                            ret=maybe_func_return_type, wh=maybe_where_clause,
                                                                            be=block_exp
                                                                        })
                                                                )

func_qualifier: CONST                                           ([ConstFQ])
                | CONST UNSAFE                                  ([ConstFQ, UnsafeFQ])
                | CONST EXTERN                                  ([ConstFQ, ExternFQ(NONE)])
                | CONST EXTERN abi                              ([ConstFQ, ExternFQ(SOME(abi))])
                | CONST UNSAFE EXTERN                           ([ConstFQ, UnsafeFQ, ExternFQ(NONE)])
                | CONST UNSAFE EXTERN abi                       ([ConstFQ, UnsafeFQ, ExternFQ(SOME(abi))])
                | UNSAFE                                        ([UnsafeFQ])
                | UNSAFE EXTERN                                 ([UnsafeFQ, ExternFQ(NONE)])
                | UNSAFE EXTERN abi                             ([UnsafeFQ, ExternFQ(SOME(abi))])
                | EXTERN                                        ([ExternFQ(NONE)])
                | EXTERN abi                                    ([ExternFQ(SOME(abi))])
                |                                               ([])

maybe_abi: abi                                                  (SOME(abi))
        |                                                       (NONE)

abi: STR_LIT                                                    (Abi(STR_LIT))
    | RAW_STR_LIT                                               (Abi(RAW_STR_LIT))

maybe_func_parameters: func_parameters                          (func_parameters)
                    |                                           ([])

func_parameters: func_param func_parameters_expansion 
                maybe_comma                                     (func_param::rev(func_parameters_expansion))

func_parameters_expansion: 
                        (* This is a left recursion to solve COMMA conflicts *)
                        func_parameters_expansion 
                        COMMA func_param                        (func_param::func_parameters_expansion)
                        |                                       (nil)

func_param: patterns COLON types                                (FunctionParam (patterns, types))

maybe_func_return_type: func_return_type                        (SOME(func_return_type))
                        |                                       (NONE)
func_return_type: RARROW types                                  (types)

struct_struct: STRUCT IDENT maybe_generics maybe_where_clause
                LBRACE maybe_struct_fields RBRACE               (StructStruct (Identifer(IDENT), maybe_generics, maybe_where_clause, maybe_struct_fields))
            | STRUCT IDENT maybe_generics maybe_where_clause
                SEMI                                            (UnitStruct (Identifer(IDENT), maybe_generics, maybe_where_clause))

maybe_struct_fields: struct_fields                              (struct_fields)
                    |                                           ([])
struct_fields: struct_field struct_fields_expansion maybe_comma (struct_field::rev(struct_fields_expansion))

struct_fields_expansion:
                        (* This is a left recursion to solve COMMA conflicts *)
                        struct_fields_expansion
                        COMMA struct_field                      (struct_field::struct_fields_expansion)
                        |                                       (nil)
struct_field: outer_attrs visibility IDENT COLON types          (StructField (rev(outer_attrs), visibility, Identifer(IDENT), types))
                | outer_attrs IDENT COLON types                 (StructField (rev(outer_attrs), DefaultVis, Identifer(IDENT), types))

tuple_struct: STRUCT IDENT maybe_generics 
                LPARENT maybe_tuple_fields 
                RPARENT maybe_where_clause SEMI                 (TupleStruct (Identifer(IDENT), maybe_generics, maybe_tuple_fields, maybe_where_clause))
maybe_tuple_fields: tuple_fields                                (tuple_fields)
                    |                                           ([])
tuple_fields: tuple_field tuple_fields_expansion maybe_comma    (tuple_field::rev(tuple_fields_expansion))
tuple_fields_expansion: 
                        (* This is a left recursion to solve COMMA conflicts *)
                        tuple_fields_expansion 
                        COMMA tuple_field                       (tuple_field::tuple_fields_expansion)
                        |                                       (nil)
tuple_field: outer_attrs visibility types                       (TupleField (rev(outer_attrs), visibility, types))
            | outer_attrs types                                 (TupleField (rev(outer_attrs), DefaultVis, types))

maybe_enum_items: enum_items                                    (enum_items)
                |                                               ([])
enum_items: enum_item enum_items_expansion maybe_comma          (yaccLog("enum_items"); enum_item::rev(enum_items_expansion))
enum_items_expansion: 
                    (* This is a left recursion to solve COMMA conflicts *)
                    enum_items_expansion COMMA enum_item        (enum_item::enum_items_expansion)
                    |                                           (nil)
enum_item: outer_attrs IDENT enum_item_tuple                    (EnumItem (rev(outer_attrs), Identifer(IDENT), SOME(enum_item_tuple)))
            | outer_attrs IDENT enum_item_struct                (EnumItem (rev(outer_attrs), Identifer(IDENT), SOME(enum_item_struct)))
            | outer_attrs IDENT enum_item_discriminant          (EnumItem (rev(outer_attrs), Identifer(IDENT), SOME(enum_item_discriminant)))
            | outer_attrs IDENT                                 (yaccLog("enum_item: branch 4"); EnumItem (rev(outer_attrs), Identifer(IDENT), NONE))

enum_item_tuple: LPARENT maybe_tuple_fields RPARENT             (EnumItemTuple (maybe_tuple_fields))
enum_item_struct: LBRACE maybe_struct_fields RBRACE             (EnumItemStruct (maybe_struct_fields))
enum_item_discriminant: EQ expression                           (EnumItemDiscriminant (expression))

trait_items: trait_items trait_item                             (trait_item::trait_items)
            |                                                   (nil)
trait_item: outer_attrs trait_func                              (TraitItem (outer_attrs, trait_func))
            | outer_attrs trait_method                          (TraitItem (outer_attrs, trait_method))
            | outer_attrs trait_const                           (TraitItem (outer_attrs, trait_const))
            | outer_attrs trait_type                            (TraitItem (outer_attrs, trait_type))
            | outer_attrs macro_invocation_semi                 (TraitItem (outer_attrs, TraitMIS(macro_invocation_semi)))

trait_func: trait_func_decl SEMI                                (TraitFunc (trait_func_decl, NONE))
            | trait_func_decl block_exp                         (TraitFunc (trait_func_decl, SOME (block_exp)))
trait_method: trait_method_decl SEMI                            (TraitMethod (trait_method_decl, NONE))
            | trait_method_decl block_exp                       (TraitMethod (trait_method_decl, SOME (block_exp)))
trait_func_decl: func_qualifier FN IDENT maybe_generics
                    LPARENT maybe_trait_func_parameters 
                    RPARENT maybe_func_return_type 
                    maybe_where_clause                          (TraitFuncDecl ({
                                                                    qualifier=func_qualifier, name=Identifer(IDENT), generic=maybe_generics, 
                                                                    params=maybe_trait_func_parameters, ret=maybe_func_return_type, 
                                                                    wh=maybe_where_clause
                                                                }))
maybe_trait_func_parameters: trait_func_parameters              (trait_func_parameters)
                                |                               ([])
trait_method_decl: func_qualifier FN IDENT maybe_generics
                    LPARENT self_param
                    trait_func_parameters_expansion maybe_comma
                    RPARENT maybe_func_return_type
                    maybe_where_clause                          (TraitMethodDecl({
                                                                    qualifier=func_qualifier, name=Identifer(IDENT), generic=maybe_generics, 
                                                                    selfParam=self_param, params=trait_func_parameters_expansion, ret=maybe_func_return_type, 
                                                                    wh=maybe_where_clause
                                                                }))
trait_func_parameters: trait_func_param 
                trait_func_parameters_expansion maybe_comma     (trait_func_param::rev(trait_func_parameters_expansion))
trait_func_parameters_expansion: 
    trait_func_parameters_expansion COMMA trait_func_param      (trait_func_param::trait_func_parameters_expansion)
                            |                                   (nil)
trait_func_param:  patterns COLON types                         (TraitFunctionParam (SOME(patterns), types))
                (* | types                                         (TraitFunctionParam (NONE, types)) *)
trait_const: CONST IDENT COLON types SEMI                       (TraitConst (Identifer(IDENT), types, NONE))
            | CONST IDENT COLON types EQ expression SEMI        (TraitConst (Identifer(IDENT), types, SOME(expression)))
trait_type: TYPE IDENT maybe_colon_type_bounds SEMI             (TraitType (Identifer(IDENT), maybe_colon_type_bounds))
maybe_type_param_bounds: type_param_bounds                      (SOME(type_param_bounds))
                        |                                       (NONE)
(* type_param_bounds: type_param_bound type_param_bounds_expansion (TypeParamBounds(type_param_bound::rev(type_param_bounds_expansion)))
                    | type_param_bound 
                    type_param_bounds_expansion PLUS            (TypeParamBounds(type_param_bound::rev(type_param_bounds_expansion)))
type_param_bounds_expansion: type_param_bounds_expansion
                            PLUS type_param_bound               (type_param_bound::type_param_bounds_expansion)
                        |                                       (nil) *)
type_param_bounds: type_param_bounds_expansion 
                    %prec LOWER_THAN_PLUS                       (TypeParamBounds(rev(type_param_bounds_expansion)))
                    (* | type_param_bounds_expansion PLUS           (TypeParamBounds(rev(type_param_bounds_expansion))) *)
type_param_bounds_expansion: type_param_bounds_expansion
                            PLUS type_param_bound               (type_param_bound::type_param_bounds_expansion)
                        | type_param_bound                      ([type_param_bound])
type_param_bound: lifetime                                      (LTB(lifetime))
                | trait_bound                                   (TB(trait_bound))

lifetime_bounds: lifetime_bounds_expansion                      (LifetimeBounds(rev(lifetime_bounds_expansion)))
                | lifetime_bounds_expansion lifetime            (LifetimeBounds(lifetime::rev(lifetime_bounds_expansion)))
lifetime_bounds_expansion: lifetime_bounds_expansion
                    lifetime PLUS                               (lifetime::lifetime_bounds_expansion)
                    |                                           (nil)
maybe_lifetime: lifetime                                        ()
                |                                               ()

lifetime: (* here are some questions *)
          LIFETIME_OR_LABEL                                     (LifetimeOrLabel(LIFETIME_OR_LABEL))
        | STATICLIFETIME                                        (StaticLifetime)
trait_bound: type_path                                          (TraitBound(NONE, NONE, type_path))
            | for_lifetimes type_path                           (TraitBound(NONE, SOME(for_lifetimes), type_path))
            | QUESTION maybe_for_lifetimes type_path            (TraitBound(SOME(Sized), maybe_for_lifetimes, type_path))
            | LPARENT type_path RPARENT                         (TraitBound(NONE, NONE, type_path))
            | LPARENT for_lifetimes type_path RPARENT           (TraitBound(NONE, SOME(for_lifetimes), type_path))
            | LPARENT QUESTION 
                maybe_for_lifetimes type_path RPARENT           (TraitBound(SOME(Sized), maybe_for_lifetimes, type_path))


self_param: AND SELFVALUE                                       (SelfParamLT (NONE, NonMut))
            | AND MUT SELFVALUE                                 (SelfParamLT (NONE, Mut))
            | AND lifetime maybe_mut SELFVALUE                  (SelfParamLT (SOME(lifetime), maybe_mut))
            | SELFVALUE                                         (SelfParamTY (NonMut, NONE))
            | MUT SELFVALUE                                     (SelfParamTY (Mut, NONE))
            | SELFVALUE COLON types                             (SelfParamTY (NonMut, SOME(types)))
            | MUT SELFVALUE COLON types                         (SelfParamTY (Mut, SOME(types)))

(* 
    In inherent implement, to remove reduce/reduce conflicts in generics and types, 
    requiring users to provide parents delimiter around types.
*)
inherent_impl: IMPL maybe_generics LPARENT types RPARENT maybe_where_clause
                LBRACE inner_attrs inherent_impl_items RBRACE   (InherentImpl ({
                                                                    generic=maybe_generics, ty=types, wh=maybe_where_clause, 
                                                                    innerAttrs=inner_attrs, implItems=inherent_impl_items
                                                                }))
inherent_impl_items: inherent_impl_items inherent_impl_item     (inherent_impl_item::inherent_impl_items)
                    |                                           (nil)
inherent_impl_item: outer_attrs macro_invocation_semi           (InherentImplItemMacro (outer_attrs, macro_invocation_semi))
                    | outer_attrs maybe_visibility 
                        constant_item                           (InherentImplItemType (outer_attrs, maybe_visibility, constant_item))
                    | outer_attrs maybe_visibility function     (InherentImplItemType (outer_attrs, maybe_visibility, function))
                    | outer_attrs maybe_visibility method       (InherentImplItemMethod (outer_attrs, maybe_visibility, method))
trait_impl:  IMPL maybe_generics type_path
            FOR types maybe_where_clause LBRACE
            inner_attrs trait_impl_items RBRACE                 (TraitImpl({
                                                                    unsafe=NONE, generic=maybe_generics, neg=false, typath=type_path, ty=types,
                                                                    wh=maybe_where_clause, innerAttrs=inner_attrs, implItems=trait_impl_items
                                                                }))
            |IMPL maybe_generics NOT type_path
            FOR types maybe_where_clause LBRACE
            inner_attrs trait_impl_items RBRACE                 (TraitImpl({
                                                                    unsafe=NONE, generic=maybe_generics, neg=true, typath=type_path, ty=types,
                                                                    wh=maybe_where_clause, innerAttrs=inner_attrs, implItems=trait_impl_items
                                                                }))
            | UNSAFE IMPL maybe_generics  type_path
            FOR types maybe_where_clause LBRACE
            inner_attrs trait_impl_items RBRACE                 (TraitImpl({
                                                                    unsafe=SOME(Unsafe), generic=maybe_generics, neg=false, typath=type_path, ty=types,
                                                                    wh=maybe_where_clause, innerAttrs=inner_attrs, implItems=trait_impl_items
                                                                }))
            | UNSAFE IMPL maybe_generics NOT type_path
            FOR types maybe_where_clause LBRACE
            inner_attrs trait_impl_items RBRACE                 (TraitImpl({
                                                                    unsafe=SOME(Unsafe), generic=maybe_generics, neg=true, typath=type_path, ty=types,
                                                                    wh=maybe_where_clause, innerAttrs=inner_attrs, implItems=trait_impl_items
                                                                }))
trait_impl_items: trait_impl_items trait_impl_item              (trait_impl_item::trait_impl_items)
                |                                               (nil)
trait_impl_item: outer_attrs macro_invocation_semi              (TraitImplItemMacro (outer_attrs, macro_invocation_semi))
                | outer_attrs maybe_visibility type_alias       (TraitImplItemType (outer_attrs, maybe_visibility, type_alias))
                | outer_attrs maybe_visibility constant_item    (TraitImplItemType (outer_attrs, maybe_visibility, constant_item))
                | outer_attrs maybe_visibility function         (TraitImplItemType (outer_attrs, maybe_visibility, function))
                | outer_attrs maybe_visibility method           (TraitImplItemMethod (outer_attrs, maybe_visibility, method))
method: func_qualifier FN IDENT maybe_generics LPARENT
        self_param func_parameters_expansion maybe_comma RPARENT
        maybe_func_return_type maybe_where_clause 
        block_exp                                               (Method ({
                                                                    qualifier=func_qualifier, name=Identifer(IDENT), generic=maybe_generics, 
                                                                    selfParam=self_param, params=rev(func_parameters_expansion), 
                                                                    ret=maybe_func_return_type, wh=maybe_where_clause, be=block_exp
                                                                }))

extern_block: EXTERN maybe_abi LBRACE inner_attrs
            external_items RBRACE                               (ExternBlock (maybe_abi, inner_attrs, external_items))
external_items: external_items external_item                    (external_item::external_items)
            |                                                   (nil)
external_item: outer_attrs 
                maybe_visibility external_static_item           (ExternalItem (outer_attrs, maybe_visibility, external_static_item))
            | outer_attrs
                maybe_visibility external_func_item             (ExternalItem (outer_attrs, maybe_visibility, external_func_item))
external_static_item: STATIC maybe_mut IDENT COLON types SEMI   (ExternalStaticItem (maybe_mut, Identifer(IDENT), types))
external_func_item: FN IDENT maybe_generics LPARENT
                maybe_named_func_parameters RPARENT
                maybe_func_return_type maybe_where_clause
                SEMI                                            (ExternalFunctionItem ({
                                                                    name=Identifer(IDENT), generic=maybe_generics, 
                                                                    params=maybe_named_func_parameters, ret=maybe_func_return_type, 
                                                                    wh=maybe_where_clause
                                                                }))
            |   FN IDENT maybe_generics LPARENT
                named_func_parameters_with_variadics RPARENT
                maybe_func_return_type maybe_where_clause
                SEMI                                            (ExternalFunctionItem ({
                                                                    name=Identifer(IDENT), generic=maybe_generics, 
                                                                    params=named_func_parameters_with_variadics, ret=maybe_func_return_type, 
                                                                    wh=maybe_where_clause
                                                                }))

maybe_named_func_parameters: named_func_parameters              (named_func_parameters)
                        |                                       (ExternFunctionParameter ({params=[], var=false}))
named_func_parameters: named_func_param 
                named_func_parameters_expansion maybe_comma     (ExternFunctionParameter ({params=named_func_param::rev(named_func_parameters_expansion), var=false}))
named_func_parameters_expansion: 
    named_func_parameters_expansion COMMA named_func_param      (named_func_param::named_func_parameters_expansion)
                    |                                           (nil)
named_func_param: IDENT COLON types                             (NamedFunctionParam (SOME(Identifer(IDENT)), types))
                 | UNDERSCORE COLON types                       (NamedFunctionParam (NONE, types))
named_func_parameters_with_variadics:
                (* For convenient, this production is rewrote *)
                named_func_param named_func_parameters_expansion 
                COMMA DOTDOTDOT                                 (ExternFunctionParameter ({params=named_func_param::rev(named_func_parameters_expansion), var=true}))

(* ------pattern-------- *)
patterns: 
        lit_pat                                                 (yaccLog("patterns:lit_pat"); Pattern)
        | id_pat                                                (yaccLog("patterns:id_pat"); Pattern)
        | wildcard_pat                                          (yaccLog("patterns:wildcard_pat"); Pattern)
        | range_pat                                             (yaccLog("patterns:range_pat"); Pattern)
        | reference_pat                                         (yaccLog("patterns:reference_pat"); Pattern)
        | struct_pat                                            (yaccLog("patterns:struct_pat"); Pattern)
        | tuple_struct_pat                                      (yaccLog("patterns:tuple_struct_pat"); Pattern)
        | tuple_or_grouped_pat                                  (yaccLog("patterns:tuple_or_grouped_pat"); Pattern)
        | LPARENT RPARENT                                       (yaccLog("patterns:unit"); Pattern)
        (* tuple pattern contains group pattern *)
        (* | grouped_pat                                           (Pattern) *)
        | slice_pat                                             (yaccLog("patterns:slice_pat"); Pattern)
        | path_pat                                              (yaccLog("patterns:path_pat"); Pattern)

lit_pat: TRUE                                                   ()
        | FALSE                                                 ()
        | CHAR_LIT                                              ()
        | BYTE_LIT                                              ()
        | STR_LIT                                               ()
        | RAW_STR_LIT                                           ()
        | BYTE_STR_LIT                                          ()
        | RAW_BYTE_STR_LIT                                      ()
        | INTEGER_LIT                                           ()
        | MINUS INTEGER_LIT                                     ()
        | FLOAT_LIT                                             ()
        | MINUS FLOAT_LIT                                       ()

id_pat: 
        (* path pattern contains Identifier *)
        (* IDENT                                                   () *)
        binding_mode IDENT                                      ()
        | IDENT AT patterns                                     ()
        | binding_mode IDENT AT patterns                        ()

binding_mode: REF                                               ()
            | REF MUT                                           ()
            | MUT                                               ()

wildcard_pat: UNDERSCORE                                        ()

range_pat: range_pat_bound DOTDOTEQ range_pat_bound             ()
            | range_pat_bound DOTDOTDOT range_pat_bound         ()
range_pat_bound: CHAR_LIT                                       ()
                | BYTE_LIT                                      ()
                | INTEGER_LIT                                   ()
                | MINUS INTEGER_LIT                             ()
                | FLOAT_LIT                                     ()
                | MINUS FLOAT_LIT                               ()
                | path_in_exp                                   ()
                | qualified_path_in_exp                         ()

reference_pat: AND  patterns                                    ()
            | ANDAND  patterns                                  ()
            | AND MUT patterns                                  ()
            | ANDAND MUT patterns                               ()

struct_pat: path_in_exp LBRACE RBRACE                           ()
            | path_in_exp LBRACE struct_pat_elements RBRACE     ()
struct_pat_elements: struct_pat_etcetera                        ()
                    | struct_pat_fields COMMA                   ()
                    | struct_pat_fields 
                        COMMA struct_pat_etcetera               ()
                    | struct_pat_fields                         ()
struct_pat_fields: struct_pat_fields COMMA struct_pat_field     ()
                    | struct_pat_field                          ()
struct_pat_field: outer_attrs INTEGER_LIT COLON patterns        ()
                | outer_attrs IDENT COLON patterns              ()
                | outer_attrs IDENT                             ()
                | outer_attrs REF IDENT                         ()
                | outer_attrs REF MUT IDENT                     ()
                | outer_attrs MUT IDENT                         ()
struct_pat_etcetera: outer_attrs DOTDOT                         ()

tuple_struct_pat: path_in_exp 
                LPARENT tuple_pat_items RPARENT                 ()
                | path_in_exp 
                LPARENT tuple_pat_items COMMA RPARENT           ()
                | path_in_exp 
                LPARENT DOTDOT RPARENT                          ()
                | path_in_exp 
                LPARENT tuple_pat_items COMMA DOTDOT RPARENT    ()
                | path_in_exp 
                    LPARENT DOTDOT 
                    COMMA tuple_pat_items maybe_comma RPARENT   ()
                | path_in_exp 
                    LPARENT tuple_pat_items COMMA DOTDOT
                    COMMA tuple_pat_items maybe_comma RPARENT   ()

tuple_or_grouped_pat: LPARENT tuple_pat_items RPARENT           ()
            | LPARENT tuple_pat_items COMMA RPARENT             ()
            | LPARENT DOTDOT RPARENT                            ()
            | LPARENT tuple_pat_items COMMA DOTDOT RPARENT      ()
            | LPARENT DOTDOT 
                COMMA tuple_pat_items maybe_comma RPARENT       ()
            | LPARENT tuple_pat_items COMMA DOTDOT 
                COMMA tuple_pat_items maybe_comma RPARENT       ()
tuple_pat_items: tuple_pat_items COMMA patterns                 ()
                | patterns                                      ()

slice_pat: LBRACKET tuple_pat_items maybe_comma RBRACKET        ()

path_pat: path_in_exp                                           ()
        | qualified_path_in_exp                                 ()

(* ------Type------ *)
types: type_no_bounds                                           (Type)
        (* | IMPL type_param_bounds                                (Type) *)
        | IMPL lifetime                                         (Type)
        | IMPL trait_bound PLUS type_param_bounds               (Type)
        (* | DYN type_param_bounds                                 (Type) *)
        | DYN lifetime                                          (Type)
        | DYN trait_bound PLUS type_param_bounds                (Type)
type_no_bounds: 
                LPARENT types RPARENT %prec LPARENT             ()
                (* ImplTraitType contains Impl TraitTypeOneBound  *)
                | IMPL trait_bound %prec LOWER_THAN_PLUS        ()
                (* 
                    Trait Object Type One Bound production must 
                    have keyword dyn for avoiding conflicts. 
                *)
                (* TraitObjectType contains Impl TraitObjectTypeOneBound   *)
                | DYN trait_bound %prec LOWER_THAN_PLUS         ()
                (* trait_bound contains LPARENT type_path RPARENT *)
                (* | trait_bound                                   () *)
                | type_path %prec LOWER_THAN_PATHSEP            ()
                | LPARENT RPARENT                               ()
                | LPARENT types COMMA 
                    types_expansion maybe_comma RPARENT         ()
                | NOT                                           ()
                | STAR MUT type_no_bounds                       ()
                | STAR CONST type_no_bounds                     ()
                | AND maybe_lifetime maybe_mut type_no_bounds   ()
                | LBRACKET types SEMI expression RBRACKET       ()
                | LBRACKET types RBRACKET                       ()
                | UNDERSCORE                                    ()  
                | qualified_path_in_type                        ()
                | maybe_for_lifetimes 
                    func_qualifier FN LPARENT RPARENT           ()
                |  maybe_for_lifetimes 
                    func_qualifier FN LPARENT 
                    maybe_named_bare_func_parameters maybe_comma 
                    RPARENT                                     ()
                |  maybe_for_lifetimes 
                    func_qualifier FN LPARENT 
                    maybe_named_bare_func_parameters_variadic 
                    RPARENT                                     ()
                | maybe_for_lifetimes 
                    func_qualifier FN LPARENT RPARENT 
                    RARROW type_no_bounds                       ()
                |  maybe_for_lifetimes 
                    func_qualifier FN LPARENT 
                    maybe_named_bare_func_parameters maybe_comma 
                    RPARENT RARROW type_no_bounds               ()
                |  maybe_for_lifetimes 
                    func_qualifier FN LPARENT 
                    maybe_named_bare_func_parameters_variadic 
                    RPARENT                                     
                    RARROW type_no_bounds                       ()
                (* | macro_invocation                              () *)
                (* TypePath contains PathInExpression, 
                rewrite MarcoInvocation for avoiding conflicts, 
                maybe need to check TypePathFn. *)
                | type_path NOT delim_token_tree              ()
types_expansion: types_expansion COMMA types                    ()
                | types                                         ()                
maybe_named_bare_func_parameters: 
                maybe_named_bare_func_parameters 
                COMMA maybe_named_param                         ()
                | maybe_named_param                             ()
maybe_named_bare_func_parameters_variadic: 
            maybe_named_bare_func_parameters COMMA DOTDOTDOT    ()

(* ------Statements and Expression------ *)
block_exp: LBRACE inner_attrs RBRACE                            (yaccLog("block_exp:1"); BlockExpression)
        | LBRACE inner_attrs statements RBRACE                  (yaccLog("block_exp:2"); BlockExpression)
statements: statements_expansion                                ()
            | statements_expansion exp_without_block            ()
            | exp_without_block                                 ()
statements_expansion: statements_expansion statement            ()
                    | statement                                 ()
statement: (* need to be completed *)
            SEMI                                                ()
            (* Use "vis_item" replace "item" for avoiding conflicts. *)
            (* | item                                              () *)
            | outer_attrs vis_item                              ()
            | let_statement                                     ()
            | exp_statement                                     ()
            (* item contain macro item *)
            | macro_invocation_semi                             ()
let_statement: outer_attrs LET patterns SEMI                    ()
            | outer_attrs LET patterns COLON types SEMI         ()
            | outer_attrs LET patterns EQ expression SEMI       ()
            | outer_attrs LET patterns 
                COLON types EQ expression SEMI                  ()
exp_statement: exp_without_block SEMI                           ()
            (* | exp_with_block                                    () *)
expression: exp_without_block                                   (Expression)
            | exp_with_block                                    (Expression)

exp_nostruct: lit_exp                                           ()
            | path_exp                                          ()
            (* borrow exp_nostruct*)
            | AND exp_nostruct                                  ()
            | ANDAND exp_nostruct                               ()
            | AND MUT exp_nostruct                              ()
            | ANDAND MUT exp_nostruct                           ()
            (* dereference exp_nostruct*)
            | STAR exp_nostruct                                 ()
            (* question mark operator *)
            | exp_nostruct QUESTION                             ()
            (* negation exp_nostruct *)
            | MINUS exp_nostruct                                ()
            | NOT exp_nostruct                                  ()
            (* arithmetic or logical exp_nostruct *)
            | exp_nostruct PLUS exp_nostruct                    ()
            | exp_nostruct MINUS exp_nostruct                   ()
            | exp_nostruct STAR exp_nostruct                    ()
            | exp_nostruct SLASH exp_nostruct                   ()
            | exp_nostruct PERCENT exp_nostruct                 ()
            | exp_nostruct AND exp_nostruct                     ()
            | exp_nostruct OR exp_nostruct                      ()
            | exp_nostruct CARET exp_nostruct                   ()
            | exp_nostruct SHL exp_nostruct                     ()
            | exp_nostruct SHR exp_nostruct                     ()
            (* comparision exp_nostruct  *)
            | exp_nostruct EQEQ exp_nostruct                    ()
            | exp_nostruct NE exp_nostruct                      ()
            | exp_nostruct GT exp_nostruct                      ()
            | exp_nostruct LT exp_nostruct                      ()
            | exp_nostruct GE exp_nostruct                      ()
            | exp_nostruct LE exp_nostruct                      ()
            (* lazy boolean exp_nostruct *)
            | exp_nostruct OROR exp_nostruct                    ()
            | exp_nostruct ANDAND exp_nostruct                  ()
            (* type case exp_nostruct *)
            | exp_nostruct AS type_no_bounds                    ()
            (* assignment exp_nostruct *)
            | exp_nostruct EQ exp_nostruct                      ()
            (* compound assignment exp_nostruct *)
            | exp_nostruct PLUSEQ exp_nostruct                  ()
            | exp_nostruct MINUSEQ exp_nostruct                 ()
            | exp_nostruct STAREQ exp_nostruct                  ()
            | exp_nostruct SLASHEQ exp_nostruct                 ()
            | exp_nostruct PERCENTEQ exp_nostruct               ()
            | exp_nostruct ANDEQ exp_nostruct                   ()
            | exp_nostruct OREQ exp_nostruct                    ()
            | exp_nostruct CARETEQ exp_nostruct                 ()
            | exp_nostruct SHLEQ exp_nostruct                   ()
            | exp_nostruct SHREQ exp_nostruct                   ()
            | grouped_exp                                       ()
            | array_exp                                         ()
            | exp_nostruct LBRACKET expression RBRACKET         ()
            | tuple_exp                                         ()
            | exp_nostruct DOT INTEGER_LIT                      ()
            | exp_nostruct LPARENT RPARENT                      ()
            | exp_nostruct LPARENT call_params RPARENT          ()
            | exp_nostruct DOT IDENT                            ()
            (* clousre *)
            | OR OR exp_nostruct                                ()
            | OR OR RARROW type_no_bounds block_exp             ()
            | MOVE OR OR exp_nostruct                           ()
            | MOVE OR OR RARROW type_no_bounds block_exp        ()
            | OR closure_parameters OR exp_nostruct             ()
            | OR closure_parameters OR 
                RARROW type_no_bounds block_exp                 ()
            | MOVE OR closure_parameters OR exp_nostruct        ()
            | MOVE OR closure_parameters OR 
                RARROW type_no_bounds block_exp                 ()
            
            | continue_exp                                      ()
            | break_exp                                         ()
            (* range *)
            | exp_nostruct DOTDOT exp_nostruct                  (yaccLog("Range hit"))
            | exp_nostruct DOTDOT                               (yaccLog("RangeFrom hit"))
            | DOTDOT exp_nostruct                               (yaccLog("RangeTo hit"))
            | DOTDOT                                            (yaccLog("RangeFull hit"))
            | exp_nostruct DOTDOTEQ exp_nostruct                (yaccLog("RangeInclusive hit"))
            | DOTDOTEQ exp_nostruct                             (yaccLog("RangeToInclusive hit"))
            | return_exp                                        ()
            | exp_with_block                                    ()

exp_without_block: (* outer_attrs before exp *)
                 lit_exp                                        ()
                | path_exp                                      ()
                | op_exp                                        ()
                | grouped_exp                                   ()
                | array_exp                                     (yaccLog("array_exp hit"))
                | index_exp                                     (yaccLog("index_exp hit"))
                | tuple_exp                                     ()
                | tuple_index_exp                               ()
                | struct_exp                                    (yaccLog("struct_exp hit"))
                (* struct exp contains enum *)
                (* | enum_var_exp                                  () *)
                | call_exp                                      ()
                | method_call_exp                               ()
                | field_exp                                     ()
                | closure_exp                                   (yaccLog("closure_exp hit"))
                | continue_exp                                  ()
                | break_exp                                     (yaccLog("break_exp hit"))
                | range_exp                                     ()
                | return_exp                                    ()
                (* macro_invocation_semi contains macro_invocation *)
                (* | macro_invocation                              () *)

lit_exp: str_lit                                                (LiteralExpression(str_lit))
        | bool_lit                                              (LiteralExpression(bool_lit))
        | CHAR_LIT                                              (LiteralExpression(CharLit(CHAR_LIT, Pos(CHAR_LITleft))))
        | BYTE_LIT                                              (LiteralExpression(ByteLit(BYTE_LIT, Pos(BYTE_LITleft))))
        | INTEGER_LIT                                           (LiteralExpression(IntegerLit(INTEGER_LIT, Pos(INTEGER_LITleft))))
        | FLOAT_LIT                                             (LiteralExpression(FloatLit(FLOAT_LIT, Pos(FLOAT_LITleft))))
bool_lit: TRUE                                                  (True(Pos(TRUEleft)))
        | FALSE                                                 (False(Pos(FALSEleft)))
str_lit: STR_LIT                                                (StrLit(STR_LIT, Pos(STR_LITleft)))
        | RAW_STR_LIT                                           (RawStrLit(RAW_STR_LIT, Pos(RAW_STR_LITleft)))
        | BYTE_STR_LIT                                          (ByteStrLit(BYTE_STR_LIT, Pos(BYTE_STR_LITleft)))
        | RAW_BYTE_STR_LIT                                      (RawByteStrLit(RAW_BYTE_STR_LIT, Pos(RAW_BYTE_STR_LITleft)))

path_exp: path_in_exp %prec LOWER_THAN_LPARENT                  ()
        | qualified_path_in_exp                                 ()


op_exp: (* borrow expression*)
        AND expression                                          ()
        | ANDAND expression                                     ()
        | AND MUT expression                                    ()
        | ANDAND MUT expression                                 ()
        (* dereference expression*)
        | STAR expression                                       ()
        (* question mark operator *)
        | expression QUESTION                                   ()
        (* negation expression *)
        | MINUS expression                                      ()
        | NOT expression                                        ()
        (* arithmetic or logical expression *)
        | expression PLUS expression                            ()
        | expression MINUS expression                           ()
        | expression STAR expression                            ()
        | expression SLASH expression                           ()
        | expression PERCENT expression                         ()
        | expression AND expression                             ()
        | expression OR expression                              ()
        | expression CARET expression                           ()
        | expression SHL expression                             ()
        | expression SHR expression                             ()
        (* comparision expression  *)
        | expression EQEQ expression                            ()
        | expression NE expression                              ()
        | expression GT expression                              ()
        | expression LT expression                              ()
        | expression GE expression                              ()
        | expression LE expression                              ()
        (* lazy boolean expression *)
        | expression OROR expression                            ()
        | expression ANDAND expression                          ()
        (* type case expression *)
        | expression AS type_no_bounds                          ()
        (* assignment expression *)
        | expression EQ expression                              ()
        (* compound assignment expression *)
        | expression PLUSEQ expression                          ()
        | expression MINUSEQ expression                         ()
        | expression STAREQ expression                          ()
        | expression SLASHEQ expression                         ()
        | expression PERCENTEQ expression                       ()
        | expression ANDEQ expression                           ()
        | expression OREQ expression                            ()
        | expression CARETEQ expression                         ()
        | expression SHLEQ expression                           ()
        | expression SHREQ expression                           ()

grouped_exp: LPARENT inner_attrs expression RPARENT             ()

array_exp: LBRACKET inner_attrs array_elements RBRACKET         ()
            | LBRACKET inner_attrs RBRACKET                     ()
array_elements: expression SEMI expression                      ()
            | array_elements_expansion maybe_comma              ()
array_elements_expansion: array_elements_expansion 
                        COMMA expression                        ()
                        | expression                            () 

index_exp: expression LBRACKET expression RBRACKET              ()

tuple_exp: LPARENT inner_attrs RPARENT                          ()
            | LPARENT inner_attrs tuple_elements RPARENT        ()
tuple_elements: tuple_elements_expansion                        ()
            | tuple_elements_expansion expression               ()
tuple_elements_expansion: tuple_elements_expansion 
                        expression COMMA                        ()
                        | expression COMMA                      ()

tuple_index_exp: expression DOT INTEGER_LIT                     ()

struct_exp: struct_exp_struct                                   ()
            | struct_exp_tuple                                  ()
            (* path_in_exp is ambigous with path exp *)
            (* | struct_exp_unit                                   () *)
struct_exp_struct: path_in_exp 
                LBRACE inner_attrs struct_exp_fields RBRACE     ()        
                | path_in_exp 
                LBRACE inner_attrs struct_base RBRACE           ()
                | path_in_exp LBRACE inner_attrs RBRACE         ()
struct_exp_fields: struct_exp_fields_expansion                  ()
                | struct_exp_fields_expansion COMMA             ()
                | struct_exp_fields_expansion COMMA struct_base ()
struct_exp_fields_expansion: struct_exp_fields_expansion
                            COMMA struct_exp_field              ()
                            | struct_exp_field                  ()
struct_exp_field: IDENT                                         ()
                | IDENT COLON expression                        ()
                | INTEGER_LIT COLON expression                  ()
struct_base: DOTDOT expression                                  ()
struct_exp_tuple: path_in_exp 
            LPARENT inner_attrs expressions RPARENT 
            %prec LPARENT                                       ()
            | path_in_exp 
            LPARENT inner_attrs expressions COMMA RPARENT 
            %prec LPARENT                                       ()
expressions: expressions COMMA expression                       ()
            | expression                                        ()
struct_exp_unit: path_in_exp                                    ()

call_exp: expression LPARENT RPARENT                            ()
        | expression LPARENT call_params RPARENT                ()
call_params: call_params_expansion                              ()
            | call_params_expansion COMMA                       ()
call_params_expansion: call_params_expansion COMMA expression   ()
                    | expression                                ()

(* method_call_exp: expression DOT path_exp_segment LPARENT RPARENT 
                    %prec LPARENT                               ()
                | expression DOT path_exp_segment LPARENT
                    call_params RPARENT  
                    %prec LPARENT                               () *)

method_call_exp: expression DOT IDENT LPARENT
                    maybe_call_params RPARENT                   ()
                | expression DOT SUPER LPARENT
                    maybe_call_params RPARENT                   ()
                | expression DOT SELFVALUE LPARENT
                    maybe_call_params RPARENT                   ()
                | expression DOT SELFTYPE LPARENT
                    maybe_call_params RPARENT                   ()
                | expression DOT CRATE LPARENT
                    maybe_call_params RPARENT                   ()
                 | expression DOT DOLLAR CRATE LPARENT
                    maybe_call_params RPARENT                   ()
                | expression DOT IDENT PATHSEP generic_args
                    LPARENT maybe_call_params RPARENT           ()
                | expression DOT SUPER PATHSEP generic_args
                    LPARENT maybe_call_params RPARENT           ()
                | expression DOT SELFVALUE PATHSEP generic_args 
                    LPARENT maybe_call_params RPARENT           ()
                | expression DOT SELFTYPE PATHSEP generic_args
                    LPARENT maybe_call_params RPARENT           ()
                | expression DOT CRATE PATHSEP generic_args
                    LPARENT maybe_call_params RPARENT           ()
                | expression DOT DOLLAR CRATE PATHSEP generic_args 
                    LPARENT maybe_call_params RPARENT           ()

maybe_call_params: call_params                                  ()
                |                                               ()

field_exp: expression DOT IDENT                                 ()

closure_exp: OR OR expression                                   ()
            | OR OR RARROW type_no_bounds block_exp             ()
            | MOVE OR OR expression                             ()
            | MOVE OR OR RARROW type_no_bounds block_exp        ()
            | OR closure_parameters OR expression               ()
            | OR closure_parameters OR 
                RARROW type_no_bounds block_exp                 ()
            | MOVE OR closure_parameters OR expression          ()
            | MOVE OR closure_parameters OR 
                RARROW type_no_bounds block_exp                 ()
closure_parameters: closure_param closure_parameters_expansion  ()
                    | closure_param 
                        closure_parameters_expansion COMMA      ()
closure_parameters_expansion: closure_parameters_expansion 
                            COMMA closure_param                 ()
                            |                                   ()
closure_param: patterns                                         ()
                | patterns COLON types                          ()

continue_exp: CONTINUE                                          ()
            | CONTINUE LIFETIME_OR_LABEL                        ()

break_exp: BREAK %prec LOWER_THAN_EXPR                          ()
        | BREAK LIFETIME_OR_LABEL %prec LOWER_THAN_EXPR         ()
        | BREAK expression %prec LOWER_THAN_EXPR                ()
        | BREAK LIFETIME_OR_LABEL expression 
            %prec LOWER_THAN_EXPR                               ()

range_exp: expression DOTDOT expression                         (yaccLog("Range hit"))
        | expression DOTDOT                                     (yaccLog("RangeFrom hit"))
        | DOTDOT expression                                     (yaccLog("RangeTo hit"))
        | DOTDOT                                                (yaccLog("RangeFull hit"))
        | expression DOTDOTEQ expression                        (yaccLog("RangeInclusive hit"))
        | DOTDOTEQ expression                                   (yaccLog("RangeToInclusive hit"))

return_exp: RETURN                                              ()
            | RETURN expression                                 ()

exp_with_block: 
            block_exp                                       ()
            (* | UNSAFE block_exp                                  () *)
            | loop_exp                                          ()
            | if_exp                                            ()
            | if_let_exp                                        ()
            | match_exp                                         ()

loop_exp: maybe_loop_label LOOP block_exp                       ()
        | maybe_loop_label WHILE exp_nostruct block_exp         ()
        | maybe_loop_label 
            WHILE LET patterns EQ exp_nostruct block_exp        ()
        | maybe_loop_label 
            FOR patterns IN exp_nostruct block_exp              ()
maybe_loop_label: LIFETIME_OR_LABEL COLON                       ()
                |                                               ()

if_exp: IF exp_nostruct block_exp                               ()
        | IF exp_nostruct block_exp ELSE block_exp              ()
        | IF exp_nostruct block_exp ELSE if_exp                 ()
        | IF exp_nostruct block_exp ELSE if_let_exp             ()

if_let_exp: IF LET patterns EQ exp_nostruct_nolazybop block_exp (yaccLog("if_let_exp:1"))
        | IF LET patterns EQ exp_nostruct_nolazybop block_exp
            ELSE block_exp                                      ()
        | IF LET patterns EQ exp_nostruct_nolazybop block_exp
            ELSE if_exp                                         ()
        | IF LET patterns EQ exp_nostruct_nolazybop block_exp
            ELSE if_let_exp                                     ()
exp_nostruct_nolazybop: 
            lit_exp                                             ()
            | path_exp                                          (yaccLog("exp_nostruct_nolazybop:path_exp"))
            (* borrow exp_nostruct_nolazybop*)
            | AND exp_nostruct_nolazybop                        ()
            | ANDAND exp_nostruct_nolazybop                     ()
            | AND MUT exp_nostruct_nolazybop                    ()
            | ANDAND MUT exp_nostruct_nolazybop                 ()
            (* dereference exp_nostruct_nolazybop*)
            | STAR exp_nostruct_nolazybop                       ()
            (* question mark operator *)
            | exp_nostruct_nolazybop QUESTION                   ()
            (* negation exp_nostruct *)
            | MINUS exp_nostruct_nolazybop                      ()
            | NOT exp_nostruct_nolazybop                        ()
            (* arithmetic or logical exp_nostruct_nolazybop *)
            | exp_nostruct_nolazybop 
                PLUS exp_nostruct_nolazybop                     ()
            | exp_nostruct_nolazybop 
                MINUS exp_nostruct_nolazybop                    ()
            | exp_nostruct_nolazybop 
                STAR exp_nostruct_nolazybop                     ()
            | exp_nostruct_nolazybop 
                SLASH exp_nostruct_nolazybop                    ()
            | exp_nostruct_nolazybop 
                PERCENT exp_nostruct_nolazybop                  ()
            | exp_nostruct_nolazybop 
                AND exp_nostruct_nolazybop                      ()
            | exp_nostruct_nolazybop 
                OR exp_nostruct_nolazybop                       ()
            | exp_nostruct_nolazybop 
                CARET exp_nostruct_nolazybop                    ()
            | exp_nostruct_nolazybop 
                SHL exp_nostruct_nolazybop                      ()
            | exp_nostruct_nolazybop 
                SHR exp_nostruct_nolazybop                      ()
            (* comparision exp_nostruct_nolazybop  *)
            | exp_nostruct_nolazybop 
                EQEQ exp_nostruct_nolazybop                     ()
            | exp_nostruct_nolazybop 
                NE exp_nostruct_nolazybop                       ()
            | exp_nostruct_nolazybop 
                GT exp_nostruct_nolazybop                       ()
            | exp_nostruct_nolazybop 
                LT exp_nostruct_nolazybop                       ()
            | exp_nostruct_nolazybop 
                GE exp_nostruct_nolazybop                       ()
            | exp_nostruct_nolazybop 
                LE exp_nostruct_nolazybop                       ()
            (* type case exp_nostruct_nolazybop *)
            | exp_nostruct_nolazybop 
                AS type_no_bounds                               ()
            (* assignment exp_nostruct_nolazybop *)
            | exp_nostruct_nolazybop 
                EQ exp_nostruct_nolazybop                       ()
            (* compound assignment exp_nostruct_nolazybop *)
            | exp_nostruct_nolazybop 
                PLUSEQ exp_nostruct_nolazybop                   ()
            | exp_nostruct_nolazybop 
                MINUSEQ exp_nostruct_nolazybop                  ()
            | exp_nostruct_nolazybop 
                STAREQ exp_nostruct_nolazybop                   ()
            | exp_nostruct_nolazybop 
                SLASHEQ exp_nostruct_nolazybop                  ()
            | exp_nostruct_nolazybop 
                PERCENTEQ exp_nostruct_nolazybop                ()
            | exp_nostruct_nolazybop 
                ANDEQ exp_nostruct_nolazybop                    ()
            | exp_nostruct_nolazybop 
                OREQ exp_nostruct_nolazybop                     ()
            | exp_nostruct_nolazybop 
                CARETEQ exp_nostruct_nolazybop                  ()
            | exp_nostruct_nolazybop 
                SHLEQ exp_nostruct_nolazybop                    ()
            | exp_nostruct_nolazybop 
                SHREQ exp_nostruct_nolazybop                    ()
            | grouped_exp                                       ()
            | array_exp                                         ()
            | exp_nostruct_nolazybop 
                LBRACKET expression RBRACKET                    ()
            | tuple_exp                                         ()
            | exp_nostruct_nolazybop DOT INTEGER_LIT            ()
            | exp_nostruct_nolazybop LPARENT RPARENT            ()
            | exp_nostruct_nolazybop LPARENT call_params RPARENT()
            | exp_nostruct_nolazybop DOT IDENT                  ()
            (* clousre *)
            | OR OR exp_nostruct_nolazybop                      ()
            | OR OR RARROW type_no_bounds block_exp             ()
            | MOVE OR OR exp_nostruct_nolazybop                 ()
            | MOVE OR OR RARROW type_no_bounds block_exp        ()
            | OR closure_parameters OR exp_nostruct_nolazybop   ()
            | OR closure_parameters OR 
                RARROW type_no_bounds block_exp                 ()
            | MOVE OR closure_parameters 
                OR exp_nostruct_nolazybop                       ()
            | MOVE OR closure_parameters OR 
                RARROW type_no_bounds block_exp                 ()
            
            | continue_exp                                      ()
            | break_exp                                         ()
            (* range *)
            | exp_nostruct_nolazybop 
                DOTDOT exp_nostruct_nolazybop                   (yaccLog("Range hit"))
            | exp_nostruct_nolazybop DOTDOT                     (yaccLog("RangeFrom hit"))
            | DOTDOT exp_nostruct_nolazybop                     (yaccLog("RangeTo hit"))
            | DOTDOT                                            (yaccLog("RangeFull hit"))
            | exp_nostruct_nolazybop 
                DOTDOTEQ exp_nostruct_nolazybop                 (yaccLog("RangeInclusive hit"))
            | DOTDOTEQ exp_nostruct_nolazybop                   (yaccLog("RangeToInclusive hit"))
            | return_exp                                        ()
            | exp_with_block                                    ()

match_exp: MATCH exp_nostruct LBRACE inner_attrs RBRACE         ()
        | MATCH exp_nostruct 
            LBRACE inner_attrs match_arms RBRACE                ()
match_arms: match_arms_expansion                                ()
            | match_arms_expansion COMMA                        ()

(* expression conatins block_exp *)
match_arms_expansion: 
                    (* match_arms_expansion 
                        COMMA match_arm FATARROW block_exp      () *)
                    match_arms_expansion 
                        COMMA match_arm FATARROW expression     ()
                    (* | match_arm FATARROW block_exp              () *)
                    | match_arm FATARROW expression             ()
match_arm: outer_attrs match_arm_patterns                       ()
        | outer_attrs match_arm_patterns match_arm_guard        ()
match_arm_patterns: match_arm_patterns OR patterns              ()
                    | OR patterns                               ()
                    | patterns                                  ()
match_arm_guard: IF expression                                  ()

(* -----token------- *)
token_no_delim_kleene_dollar: AS                                ()
            | BREAK                                             ()
            | CONST                                             ()
            | CONTINUE                                          ()
            | CRATE                                             ()
            | ELSE                                              ()
            | ENUM                                              ()
            | EXTERN                                            ()
            | FALSE                                             ()
            | FN                                                ()
            | FOR                                               ()
            | IF                                                ()
            | IMPL                                              ()
            | IN                                                ()
            | LET                                               ()
            | LOOP                                              ()
            | MATCH                                             ()
            | MOD                                               ()
            | MOVE                                              ()
            | MUT                                               ()
            | PUB                                               ()
            | REF                                               ()
            | RETURN                                            ()
            | SELFVALUE                                         ()
            | SELFTYPE                                          ()
            | STATIC                                            ()
            | STRUCT                                            ()
            | SUPER                                             ()
            | TRAIT                                             ()
            | TRUE                                              ()
            | TYPE                                              ()
            | UNSAFE                                            ()
            | USE                                               ()
            | WHERE                                             ()
            | WHILE                                             ()
            | DYN                                               ()
            | ABSTRACT                                          ()
            | BECOME                                            ()
            | BOX                                               ()
            | DO                                                ()
            | FINAL                                             ()
            | MACRO                                             ()
            | OVERRIDE                                          ()
            | PRIV                                              ()
            | TYPEOF                                            ()
            | UNSIZED                                           ()
            | VIRTUAL                                           ()
            | YIELD                                             ()
            | ASYNC                                             ()
            | AWAIT                                             ()
            | TRY                                               ()
            | UNION                                             ()
            | STATICLIFETIME                                    ()
            | IDENT                                             ()
            | CHAR_LIT                                          ()
            | STR_LIT                                           ()
            | RAW_STR_LIT                                       ()
            | BYTE_LIT                                          ()
            | BYTE_STR_LIT                                      ()
            | RAW_BYTE_STR_LIT                                  ()
            | INTEGER_LIT                                       ()
            | TUPLE_INDEX                                       ()
            | FLOAT_LIT                                         ()
            | LIFETIME_OR_LABEL                                 ()
            | LIFETIME_TOKEN                                    ()
            | MINUS                                             ()
            | SLASH                                             ()
            | PERCENT                                           ()
            | CARET                                             ()
            | NOT                                               ()
            | AND                                               ()
            | OR                                                ()
            | ANDAND                                            ()
            | OROR                                              ()
            | SHL                                               ()
            | SHR                                               ()
            | PLUSEQ                                            ()
            | MINUSEQ                                           ()
            | STAREQ                                            ()
            | SLASHEQ                                           ()
            | PERCENTEQ                                         ()
            | CARETEQ                                           ()
            | ANDEQ                                             ()
            | OREQ                                              ()
            | SHLEQ                                             ()
            | SHREQ                                             ()
            | EQ                                                ()
            | EQEQ                                              ()
            | NE                                                ()
            | GT                                                ()
            | LT                                                ()
            | GE                                                ()
            | LE                                                ()
            | AT                                                ()
            | UNDERSCORE                                        ()
            | DOT                                               ()
            | DOTDOT                                            ()
            | DOTDOTDOT                                         ()
            | DOTDOTEQ                                          ()
            | COMMA                                             ()
            | SEMI                                              ()
            | COLON                                             ()
            | PATHSEP                                           ()
            | RARROW                                            ()
            | FATARROW                                          ()
            | POUND                                             ()
            | INNER_DOC_COMMENT                                 ()
            | OUTER_DOC_COMMENT                                 ()
            | SHEBANG                                           ()
            | INTEGER_SUFFIX                                    ()
            | FLOAT_SUFFIX                                      ()
token_no_delim_kleene: token_no_delim_kleene_dollar             ()
                    | DOLLAR                                    ()
token_no_delim_dollar: token_no_delim_kleene_dollar             ()
                | PLUS                                          ()
                | STAR                                          ()
                | QUESTION                                      ()
token_no_delim: token_no_delim_dollar                           ()
                | DOLLAR                                        ()